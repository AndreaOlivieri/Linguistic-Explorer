$(function() {
  console.log("it works");

  var img = "<img src='/images/loader.gif' class='loading'/>"

  var newURL = function(id) {
    var url = location.href
    if (/prop_id=/.test(location.href)) {
      url = url.replace(/id=[0-9]+/, "id=" + id);   
      url = url.replace(/commit=[^\&]+/, "commit=" + "Select");   
      console.log(url);
      return url;
    } else if (/\?.+/.test(location.href)) {
      return location.href + "&prop_id=" + id + "&commit=Select";
    } else  if (/\?$/.test(location.href)) {
      return location.href + "prop_id=" + id + "&commit=Select";
    } else {
      return location.href + "?prop_id=" + id + "&commit=Select";
    }
  };

  var reload = function(url) {
    $("#property-description .fluid-container").html(img);
    $("#property-setter .fluid-container").html(img);
    var data = $.get(url, function(resp) {
      $("#property-description .fluid-container").html($("#property-description .fluid-container", resp).html());
      $("#property-setter .fluid-container").html($("#property-setter .fluid-container", resp).html());
      $("#prop-select").find(":selected").prop("selected", false);
      var currentPropId = $("#prop-name").data("prop_id");
      var newOption = $("#prop-select option[value=" + currentPropId + "]");
      newOption.prop("selected", true);
    });
    window.history.pushState(null, document.title, url);

  };

  $(window).on("click", "#cat-prop option", function(e) {
    e.preventDefault();
    reload(newURL(e.target.value));
  });

  $(window).on("click", "#property-selector .btn", function(e) {
    e.preventDefault();
    var val = e.target.value;
    console.log("value");
    console.log(val);
    if (/commit/.test(location.href)) {
      var url = location.href.replace(/commit=[^&]+/, "commit=" + val); 
    } else {
      var prop_id = $('#prop-select').val()[0];
      console.log("property");
      console.log(prop_id);
      if (/\?.+/.test(location.href)) {
        var url = location.href + "&prop_id=" + prop_id + "&commit=" + val;  
      } else  if (/\?$/.test(location.href)) {
        var url = location.href + "prop_id=" + prop_id + "&commit=" + val;
      } else {
        var url = location.href + "?prop_id=" + prop_id + "&commit=" + val;
      }
    }
    console.log(url);
    reload(url);
  });

  $(window).on("click", "#save-btn", function(e) {
    e.preventDefault();
    var form = $("#value-form");
    var saveOverlay = $('#save-overlay')
    saveOverlay.css("display", "block");
    saveOverlay.css("background-color", "white");
    saveOverlay.html(img);
    $.post(form.attr("action"), form.serialize(), function(data, textStatus) {
      saveOverlay.css("background-color", "");
      if (data.success == true) {
        saveOverlay.toggleClass("alert alert-success");
        saveOverlay.html("Save Successful")
      } else {
        saveOverlay.toggleClass("alert alert-error");
        saveOverlay.html("Save Unsuccessful")
      }
      setTimeout(function() {
        saveOverlay.animate({opacity: 0}, 500, function() {
          saveOverlay.removeAttr("style");
          saveOverlay.html("");
        });
      }, 700);
      }, 'json');
  })
});
