$(function() {
  console.log("it works");
  var newURL = function(id) {
    var url = location.href
    if (/prop_id=/.test(location.href)) {
      url = url.replace(/id=[0-9]+/, "id=" + id);   
      url = url.replace(/commit=[^\&]+/, "commit=" + "Select");   
      console.log(url);
      return url;
    } else if (/\?.+/.test(location.href)) {
      return location.href + "&prop_id=" + id + "&commit=Select";
    } else  if (/\?$/.test(location.href)) {
      return location.href + "prop_id=" + id + "&commit=Select";
    } else {
      return location.href + "?prop_id=" + id + "&commit=Select";
    }
  };

  var reload = function(url) {
    var img = "<img src='/images/loader.gif' class='loading'/>"
    $("#property-description .fluid-container").html(img);
    $("#property-setter .fluid-container").html(img);
    var data = $.get(url, function(resp) {
      $("#property-description .fluid-container").html($("#property-description .fluid-container", resp).html());
      $("#property-setter .fluid-container").html($("#property-setter .fluid-container", resp).html());
    });
  };

  $(window).on("click", "#cat-prop option", function(e) {
    e.preventDefault();
    reload(newURL(e.target.value));
  });

  $(window).on("click", "#property-selector .btn", function(e) {
    e.preventDefault();
    var val = e.target.value;
    if (/commit/.test(location.href)) {
      var url = location.href.replace(/commit=[^&]+/, "commit=" + val); 
    } else {
      var prop_id = $('#prop-select').val()[0];
      console.log(prop_id);
      if (/\?.+/.test(location.href)) {
        var url = location.href + "&prop_id=" + prop_id + "&commit=" + val;  
      } else  if (/\?$/.test(location.href)) {
        var url = location.href + "prop_id=" + prop_id + "&commit=" + val;
      } else {
        var url = location.href + "?prop_id=" + prop_id + "&commit=" + val;
      }
    }
    console.log(url);
    reload(newURL(url));
  });
});
