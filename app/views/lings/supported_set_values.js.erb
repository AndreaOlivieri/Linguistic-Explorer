$(function() {

  var img = "<img id='loader' src='/images/loader.gif' class='loading'/>";
  var getData = function() {
    var data = $("#prop-name");
    return {lingId: data.data("ling_id"),
            propId: data.data("prop_id"),
            lpId: data.data("lp_id")}
  };

  var newURL = function(id) {
    var url = location.href;
    if (/prop_id=/.test(location.href)) {
      url = url.replace(/id=[0-9]+/, "id=" + id);   
      url = url.replace(/commit=[^\&]+/, "commit=" + "Select");   
      return url;
    } else if (/\?.+/.test(location.href)) {
      return location.href + "&prop_id=" + id + "&commit=Select";
    } else  if (/\?$/.test(location.href)) {
      return location.href + "prop_id=" + id + "&commit=Select";
    } else {
      return location.href + "?prop_id=" + id + "&commit=Select";
    }
  };

  var reload = function(url) {
    $("#property-description .fluid-container").html(img);
    $("#property-setter .fluid-container").html(img);
    var data = $.get(url, function(resp) {
      $("#property-description .fluid-container").html($("#property-description .fluid-container", resp).html());
      $("#property-setter .fluid-container").html($("#property-setter .fluid-container", resp).html());
      $("#prop-select").find(":selected").prop("selected", false);
      var currentPropId = getData().propId;
      var newOption = $("#prop-select option[value=" + currentPropId + "]");
      newOption.prop("selected", true);
    });
    window.history.pushState(null, document.title, url);

  };

  $(window).on("click", "#cat-prop option", function(e) {
    e.preventDefault();
    reload(newURL(e.target.value));
  });

  $(window).on("click", "#property-selector .btn", function(e) {
    e.preventDefault();
    var val = e.target.value;
    if (/commit/.test(location.href)) {
      var url = location.href.replace(/commit=[^&]+/, "commit=" + val); 
    } else {
      var prop_id = $('#prop-select').val()[0];
      if (/\?.+/.test(location.href)) {
        var url = location.href + "&prop_id=" + prop_id + "&commit=" + val;  
      } else  if (/\?$/.test(location.href)) {
        var url = location.href + "prop_id=" + prop_id + "&commit=" + val;
      } else {
        var url = location.href + "?prop_id=" + prop_id + "&commit=" + val;
      }
    }
    reload(url);
  });

  $(window).on("click", "#example-select-btn", function(e) {
    e.preventDefault();
    var form =  $("#prop-example-selector form");
    $("#prop-active-example").html(img);
    $.get(form.attr("action"), form.serialize(), function(data) {
      $("#prop-active-example").html($("#prop-active-example", data).html());
    });
  });

  $(window).on("click", "#save-btn", function(e) {
    e.preventDefault();
    var form = $("#value-form");
    var saveOverlay = $('#save-overlay')
    saveOverlay.css("display", "block");
    saveOverlay.css("background-color", "white");
    saveOverlay.html(img);
    $.post(form.attr("action"), form.serialize(), function(data) {
      saveOverlay.css("background-color", "");
      if (data.success == true) {
        saveOverlay.toggleClass("alert-success");
        saveOverlay.html("Save Successful")
        var warning = $("#example-warning");
        if (warning.length > 0) {
          warning.remove();
          $("#example-create").toggleClass("disabled enabled");
          $("#example-assign").toggleClass("disabled enabled");
        }
      } else {
        saveOverlay.toggleClass("alert-error");
        saveOverlay.html("Save Unsuccessful")
      }
      setTimeout(function() {
        saveOverlay.animate({opacity: 0}, 500, function() {
          saveOverlay.removeAttr("style");
          saveOverlay.removeClass("alert-success alert-error");
          saveOverlay.html("");
        });
      }, 700);
      }, 'json');
  })

  $(window).on("click", "#example-create.enabled", function(e) {
    e.preventDefault();
    var data = getData();
    $('.modal-header').html("<h3>Create Example</h3>");
    $('.modal-body').load("<%= new_group_example_path(current_group)  %>" + " form", "ling_id=" + data.lingId + 
      "&prop_id=" + data.propId + "lp_id=" + data.lpId, function() {
        $("#example-modal").modal('toggle');                      
      });
  });

  $(window).on("click", "#example-assign.enabled", function(e) {
    e.preventDefault();
    var data = getData();
    $('.modal-header').html("<h3>Link Example</h3>");
    $('.modal-body').load("<%= new_group_examples_lings_property_path(current_group)  %>" + " form", "ling_id=" + data.lingId + 
      "&prop_id=" + data.propId + "lp_id=" + data.lpId, function() {
        $("#example-modal").modal('toggle');                      
      });
  });

  $(window).on("click", "#example-assign.disabled", function(e) {
    e.preventDefault();
  });
  
  $(window).on("click", "#example-create.disabled", function(e) {
    e.preventDefault();
  });

});
